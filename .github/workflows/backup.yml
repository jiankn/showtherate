name: 自动备份

on:
  schedule:
    # 每周一凌晨2点执行备份
    - cron: '0 2 * * 1'
  workflow_dispatch:
    # 允许手动触发

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 安装依赖
      run: npm ci

    - name: 备份环境配置
      run: |
        mkdir -p backups/env
        node scripts/backup-env.sh

    - name: 创建备份归档
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        ARCHIVE_NAME="showtherate_backup_${TIMESTAMP}.tar.gz"

        # 创建包含代码和配置的归档
        tar -czf "$ARCHIVE_NAME" \
          --exclude='node_modules' \
          --exclude='.next' \
          --exclude='.git' \
          --exclude='*.log' \
          --exclude='backups' \
          .

        # 添加环境备份
        tar -rf "$ARCHIVE_NAME" backups/

        # 压缩为最终归档
        gzip "$ARCHIVE_NAME"

    - name: 上传到 GitHub Releases
      uses: softprops/action-gh-release@v1
      with:
        tag_name: backup-${{ github.run_number }}
        name: 自动备份 ${{ github.run_number }}
        body: |
          ShowTheRate 自动备份

          创建时间: ${{ github.event.head_commit.timestamp }}
          提交: ${{ github.sha }}

          此备份包含:
          - 源代码
          - 配置文件
          - 环境变量模板
          - 数据库迁移文件
        files: showtherate_backup_*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 清理临时文件
      run: |
        rm -f showtherate_backup_*.tar.gz
        rm -rf backups/

  notify:
    runs-on: ubuntu-latest
    needs: backup
    if: always()

    steps:
    - name: 发送通知
      run: |
        if [ "${{ needs.backup.result }}" = "success" ]; then
          echo "✅ 备份成功完成"
        else
          echo "❌ 备份失败"
          exit 1
        fi
