# 工单系统方案（STR 前缀 / IMAP 收信 / 加州工时）

## 1. 目标与约束
- 目标：后台工单系统支持用户提问、客服处理、8 小时内首次响应（按工作时段累计）。
- 工作时段：周一至周五 09:00–18:00（America/Los_Angeles）。
- 节假日：美国联邦假日（整天不计时）。
- 客服模式：单一客服自动分配。
- 绑定要求：每张工单必须绑定业务实体（如订单/项目/客户）。
- 对外开放：不提供公开 API。

## 2. 工单编号规范
- 前缀：`STR`
- 格式：`STR-000001`（固定宽度递增）
- 邮件标题必须包含：`[STR-000001] 工单标题`

## 3. 状态流转与业务规则
- 状态：新建 → 已受理（首次响应完成）→ 处理中 → 待用户反馈 → 已解决/已关闭
- 首次响应：客服首次回复（后台或邮件）即完成 SLA。
- 用户邮件回复：若当前为“待用户反馈”，自动回到“处理中”。
- 关闭规则：客服关闭需填写解决说明（可选强制）。

## 4. SLA 规则（8 小时首次响应）
- 计时只在工作时段内累计，非工作时段暂停。
- 创建时间在非工作时段：SLA 起点顺延到下一个工作时段开始。
- 提醒策略（邮件）：
  - 剩余 2 小时提醒客服
  - 剩余 30 分钟提醒客服（可抄送管理员）
  - 超时提醒并标记超时

## 5. IMAP 信息获取与操作步骤（方案 B：拉取）
### 5.1 准备邮箱
1) 创建支持邮箱（如 `support@xxx.com`），确保专用且仅用于工单。
2) 配置发件显示名（如 “Support Team”）。
3) 确保该邮箱能正常收发外部邮件。

### 5.2 开启 IMAP 并获取参数
1) 在邮箱服务商后台开启 IMAP 访问权限。
2) 若启用两步验证，生成“应用专用密码”（避免使用主密码）。
3) 记录以下 IMAP 参数（从邮箱服务商后台或帮助文档获取）：
   - IMAP Host：通常形如 `imap.example.com`
   - 端口：常见 `993`（SSL/TLS）或 `143`（STARTTLS）
   - 账号：完整邮箱地址（如 `support@xxx.com`）
   - 密码：应用专用密码或邮箱密码
   - TLS：启用

### 5.3 组织收件目录（建议）
1) 在邮箱中新建文件夹：`Processed`、`Failed`。
2) 系统处理成功后移动至 `Processed`，失败移动至 `Failed`。
3) 可选择专用子目录（如 `INBOX/support`）作为拉取来源。

### 5.4 测试连通性（建议）
1) 用桌面邮件客户端添加该邮箱，确认 IMAP 登录成功。
2) 向该邮箱发送测试邮件，确保能收到并看到邮件内容与附件。
3) 将上述 IMAP 参数写入系统配置后再进入开发联调。

### 5.5 安全建议
- 仅授予最低权限的邮箱账号。
- IMAP 凭据保存在环境变量中，严禁写入日志。
- 设置频率限制与白名单规则，避免垃圾邮件触发异常。

## 6. 数据模型（建议字段）
### 6.1 ticket
- id
- ticket_no（如 `STR-000001`）
- title, description
- status, priority
- bind_type, bind_id
- requester_email
- assignee_id（单客服固定）
- created_at, updated_at, first_response_at
- sla_deadline, sla_status（normal / warn / overdue）

### 6.2 ticket_message
- id, ticket_id
- author_id / author_email
- source（web / email）
- body
- attachments
- created_at
- message_id, in_reply_to, references
- imap_uid, mailbox

### 6.3 sla_config
- timezone（固定 `America/Los_Angeles`）
- workdays（Mon–Fri）
- work_hours（09:00–18:00）
- holiday_calendar（美国联邦假日列表）
- warn_thresholds（2h / 30m）

## 7. 邮件处理逻辑（入站）
- 拉取频率：2–5 分钟一次。
- 去重策略：`imap_uid + message_id` 唯一约束。
- 关联规则（优先级）：
  1) 标题包含工单号（`[STR-000001]`）
  2) `In-Reply-To/References` 匹配历史 `message_id`
  3) 无匹配则可创建新工单（可配置开关）
- 权限校验：仅接受与工单创建人邮箱一致的回复，否则进“待审核”。
- 成功后：写入 `ticket_message`，必要时更新工单状态。

## 8. 邮件处理逻辑（出站）
- 触发点：工单创建、客服回复、状态变更、SLA 提醒。
- 邮件主题统一格式：`[STR-000001] 工单标题`
- 邮件正文包含：问题摘要、最新回复、工单详情链接。

## 9. 实施任务拆解（给 AI 执行）
### 阶段 A：基础数据与编号规则
- 建表：`ticket`、`ticket_message`、`sla_config`（按上面字段）。
- 生成工单号：`STR` 前缀 + 递增序列。
- 索引与唯一约束：`ticket_no`、`imap_uid+message_id`。
- 验收：可创建工单并生成编号，写入数据库。

### 阶段 B：工单创建与展示（用户侧）
- 工单提交表单（绑定业务实体必填）。
- 工单列表/详情页：可查看状态、SLA、对话记录。
- 附件上传与展示（大小/类型限制）。
- 验收：用户可创建、查看、回复自己的工单。

### 阶段 C：客服处理后台（单客服）
- 工单列表：支持状态/SLA/绑定对象筛选。
- 工单详情：回复、改状态、查看绑定对象。
- 验收：客服可处理全量工单并触发首次响应。

### 阶段 D：SLA 引擎
- 工作时段/假日计算（时区 `America/Los_Angeles`）。
- 计算 `sla_deadline` 与 `sla_status`。
- 定时任务：更新状态并发送提醒。
- 验收：跨工作时段、节假日场景计算正确。

### 阶段 E：邮件出站
- 接入邮件发送（配置 SMTP）。
- 统一邮件主题与正文模板。
- 验收：创建/回复/提醒均能发出邮件。

### 阶段 F：IMAP 入站（方案 B）
- 接入 IMAP 客户端库，按间隔拉取新邮件。
- 实现关联规则与去重。
- 解析正文/附件并写入 `ticket_message`。
- 失败处理：移动至 `Failed` 文件夹并记录日志。
- 验收：邮件回复可进入工单并驱动状态更新。

### 阶段 G：配置与运维
- 管理后台配置：工作时段、节假日、IMAP 参数。
- 监控与告警：拉取失败、发送失败、SLA 超时统计。
- 验收：配置可变更且实时生效。

## 10. 测试用例清单（关键）
- SLA：工作时段内 8 小时；跨日；节假日；创建在非工作时段。
- 邮件入站：匹配标题、匹配 References、无匹配新建。
- 去重：重复邮件不产生重复消息。
- 权限：非创建人邮件被拦截/审核。
- 附件：小/大附件、非法类型处理。

## 11. 风险与注意事项
- IMAP 拉取延迟受轮询频率影响。
- 邮件解析对不同客户端格式兼容性需重点测试。
- 节假日表需每年更新或使用可配置方案。
