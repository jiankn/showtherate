# ShowTheRate 后台管理系统 PRD

## 文档信息
- 版本：v0.1
- 日期：2026-01-03
- 负责人：jiankn
- 入口：生产 `admin.showtherate.com`，本地 `http://localhost:3000/admin`

## 背景与目标
- 目标：集中管理订阅、收入、工单数据，支撑运营、客服与财务的日常决策。
- 重点：订阅健康、月度收入、工单 SLA 与响应质量。
- 约束：仅管理员登录，无对外 API。

## 成功指标
- 管理员能在 2 分钟内完成订阅/收入/工单的关键查看。
- 仪表盘核心指标加载 < 2 秒。
- SLA 超时工单可在列表内一眼识别。

## 范围
- 登录与权限管理（Google OAuth + 单管理员）
- 订阅与客户查看
- 月度收入与账单统计
- 工单查看与处理
- 基础配置与审计日志

## 非目标
- 不提供外部开放 API
- 不做多租户或多角色权限体系
- 不对终端用户开放注册

## 用户与权限
- 角色：仅管理员
- 管理员邮箱白名单：仅 `jiankn@gmail.com`
- 非白名单邮箱：提示无权限，禁止登录

## 入口与登录
- 生产：`admin.showtherate.com`
- 本地：`http://localhost:3000/admin`
- 认证方式：Google OAuth（仅 Google）
- 安全策略：仅允许白名单邮箱，OAuth 回调校验，失败提示
- 审计：记录登录请求、IP、结果、时间

## 信息架构
- 登录页
- 仪表盘
- 订阅与客户
- 收入与账单
- 工单与客服
- 配置与审计

## 模块：登录页
- Google OAuth 登录 → 校验白名单
- 错误态：无权限、OAuth 失败
- 文案提示：仅内部管理员使用

## 模块：仪表盘
- KPI 卡片：活跃订阅、当月收入、MRR、退款、流失率、未处理工单、SLA 超时数
- 趋势图：本月每日收入、订阅新增/流失趋势
- 预警区：即将到期订阅、超时工单

## 模块：订阅与客户
- 列表字段：客户邮箱/名称、订阅状态、方案、开始/到期、MRR、最近付款
- 详情内容：订阅历史、账单记录、工单记录、使用情况摘要
- 过滤条件：状态、方案、日期区间

## 模块：收入与账单
- 本月收入概览：已支付、退款、净收入
- 维度拆分：按方案、渠道、地区（如有）
- 账单列表：状态、金额、币种、付款时间
- 导出：CSV

## 模块：工单与客服
- 列表字段：工单号、状态、SLA 剩余、绑定对象、创建人
- 详情页：消息对话、附件、SLA 状态、绑定对象信息
- 动作：回复、变更状态、关闭工单
- SLA：8 小时首次响应（按工作时段累计）

## 模块：配置与审计
- 配置项：工作时段、节假日、IMAP/SMTP、SLA 阈值
- 审计日志：登录、关键操作、失败记录

## 关键指标定义
| 指标 | 定义 |
| --- | --- |
| 活跃订阅 | 当前状态为 active 的订阅 |
| MRR | 当月活跃订阅按月标准化金额 |
| 当月收入 | 本月已支付金额合计（可切换净收入） |
| 退款 | 本月退款合计 |
| 流失率 | 本月取消数 / 期初活跃订阅数 |
| SLA 超时 | 超过 8 工作小时首次响应的工单数 |

## 数据需求（逻辑实体）
| 实体 | 关键字段 |
| --- | --- |
| 用户 | email、role、created_at |
| 订阅 | status、plan、start_at、end_at、mrr |
| 账单 | amount、currency、status、paid_at |
| 工单 | ticket_no、status、sla_deadline、first_response_at |
| 工单消息 | source、body、created_at |
| SLA 配置 | timezone、workdays、work_hours、holidays |

## 非功能需求
- 性能：核心页面 < 2 秒，列表分页加载 < 1 秒
- 安全：仅管理员可访问；后台不出现在公开导航
- 稳定：统计数据按分钟级刷新或页面加载时计算
- 合规：管理员操作日志保留至少 90 天

## 异常与边界
- 订阅数据为空：展示空状态与提示
- 工单无绑定对象：禁止提交（强校验）
- 收入数据延迟：提示“数据可能延迟同步”

## 验收标准
- 仅 `jiankn@gmail.com` 可使用 Google 登录后台
- 订阅、收入、工单数据在后台可视化且可筛选
- 工单 SLA 超时清晰可识别
- 仪表盘核心指标正确展示

## 里程碑建议
- 第 1 周：登录与仪表盘骨架
- 第 2 周：订阅与收入模块
- 第 3 周：工单模块 + SLA 展示
- 第 4 周：配置与审计 + 优化

## 假设（可调整）
- 货币默认 USD
- 订阅与账单来自支付平台（如 Stripe）或现有订阅表

## 执行计划（步骤1-5）

### 1. 数据口径与来源确认
- 任务：确认订阅/收入/工单的口径定义与字段映射（含时区：America/Los_Angeles）。
- 任务：确认月收入口径（已支付/净收入/含退款）与来源（Stripe API 或本地表）。
- 任务：确认用户标识一致性（auth.users ↔ public.users ↔ 业务表）。
- 输出：一份“字段与口径映射表”（表名、字段、计算公式、过滤条件）。
- 验收：核心 KPI 口径一致且可复用到仪表盘与列表页。

### 2. Admin 数据接口与鉴权
- 任务：新增服务端接口（例如 `/api/admin/overview`、`/api/admin/subscriptions`、`/api/admin/revenue`、`/api/admin/tickets`）。
- 任务：接口内使用 `supabaseAdmin` 读取数据；统一做“管理员邮箱白名单”校验。
- 任务：支持分页、筛选、排序参数（订阅状态/时间区间/SLA 状态）。
- 输出：可被前端调用的稳定 JSON 数据结构与错误码规范。
- 验收：非管理员访问返回 401；管理员能获取真实数据。

### 3. 前端页面数据接入
- 任务：将 admin 前端静态数据替换为接口数据（Overview/Subscriptions/Revenue/Tickets）。
- 任务：补充加载态、空状态与错误态文案。
- 任务：根据数据量增加分页与筛选 UI。
- 输出：后台页面展示真实数据，且在无数据时体验合理。
- 验收：每个页面有“加载—成功—空—错误”四种状态。

### 4. 运营能力增强
- 任务：导出 CSV（订阅、账单、工单列表）。
- 任务：SLA 预警标记（即将超时/已超时）。
- 任务：工单列表快速筛选（Open/Waiting/Closed）。
- 输出：运营人员能快速定位问题与导出数据。
- 验收：导出文件与页面筛选一致。

### 5. 上线与运维准备
- 任务：配置生产域名 `admin.showtherate.com`；确认中间件重写生效。
- 任务：Google OAuth 回调 URL 配置生产与本地地址。
- 任务：确认 Google OAuth 回调配置（本地与生产）。
- 任务：完善监控/日志（登录、关键操作、SLA 超时）。
- 输出：生产可用的 admin 登录与核心功能。
- 验收：生产登录成功，核心页面数据可访问，邮件链路稳定。
